<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8">
    <title>Understanding Synthetic Text</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js" integrity="sha512-i9cEfJwUwViEPFKdC1enz4ZRGBj8YQo6QByFTF92YXHi7waCqyexvRD75S5NVTsSiTv7rKWqG9Y5eFxmRsOn0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>


    <meta charset='utf-8'>

    <script>

      /* json from openai looks like this:
        {
          "id": "cmpl-6Y3TPUseWHES7KUTd0ThS8npfaNZM",
          "object": "text_completion",
          "created": 1673574523,
          "model": "text-davinci-002",
          "choices": [
            {
              "text": " began to think about",
              "index": 0,
              "logprobs": {
                "tokens": [
                  " began",
                  " to",
                  " think",
                  " about"
                ],
                "token_logprobs": [
                  -3.1655452,
                  -0.1254352,
                  -1.3728731,
                  -0.74598634
                ],
                "top_logprobs": [
                  {
                    " was": -1.8792582,
                    " thought": -2.7396126,
                    " noticed": -2.8234982
                  },
                  {
                    " to": -0.1254352,
                    " thinking": -3.6035988,
                    " wondering": -4.6012616
                  },
                  {
                    " think": -1.3728731,
                    " wonder": -2.0017698,
                    " feel": -2.5528724
                  },
                  {
                    " about": -0.74598634,
                    " of": -1.7520097,
                    "\n": -2.83277
                  }
                ],
                "text_offset": [
                  22,
                  28,
                  31,
                  37
                ]
              },
              "finish_reason": "length"
            }
          ],
          "usage": {
            "prompt_tokens": 7,
            "completion_tokens": 4,
            "total_tokens": 11
          }
        }
      */

      // greens from light to dark
      const colorscale = [
        "#d8f3dc",
        "#b7e4c7",
        "#95d5b2",
        "#74c69d",
        "#52b788",
        "#40916c"
      ]

      function print_words(json) {
        console.log('print_words');

        let num_tokens = $('#tokens-input').val();
        let p = $("<p>");

        // add prompt first
        p.append($("#prompt-input").val());

        // then add results
        for (var i=0; i<num_tokens; i++) {
          let logprobs = json.choices[0].logprobs;
          let token = logprobs.tokens[i];
          let alts = logprobs.top_logprobs[i]; // this is a json obj of words and logprob value

          let sorted_alts = [];
          let words = "";
          for (var key in alts) { 
            sorted_alts.push([key, alts[key]]);
            words = words + key + "(" + alts[key].toFixed(2) + ")" + " <br /> " 
          }
          sorted_alts.sort(function(a,b) { return a[1] - b[1]; } );
          let dist = sorted_alts[4][1] - sorted_alts[3][1];
          // console.log(words, sorted_alts, dist);
          let span = $("<span>").append(token + ' ');

          let index;
          if (dist > 3) { index = 0; }
          else if (dist > 2) { index = 1; }
          else if (dist > 1) { index = 2; }
          else if (dist > .75) { index = 3; }
          else if (dist > .5) { index = 4; }
          else { index = 5; }
          span.css("background-color", colorscale[index]) ;

          span.attr('data-toggle', 'tooltip').attr('data-placement', 'top').attr('title', words);
          let tooltip = new bootstrap.Tooltip(span, {'html': true});

          p.append(span);
        }

        $("#results").append(p);
      }


      function get_gpt_response() {
        var data = {
          'prompt': $('#prompt-input').val(),
          'max_tokens': $('#tokens-input').val()
        }

        $.post('get_gpt_response', data, function(json, status) {
          console.log('response:', json);
          print_words(json);
        }).fail(function(response) {
          console.log('Error: ' + response.responseText);
        });
      }


      $(document).ready( function() {
        console.log('booting up...');
        $('#submit-btn').click( function() { 
          get_gpt_response(); 
        });

      });

</script>
  </head>
  <body>

    <div class="container-fluid">

      <div class="row mt-5">
        <div class="col-4">
          <input type="text" id="prompt-input" class="form-control" placeholder="prompt">
          <div class="form-text">type in your prompt here</div>
        </div>
        <div class="col-2">
          <input type="number" min="1" max="20" step="1" id="tokens-input" class="form-control" placeholder="10">
          <div class="form-text">max tokens to generate</div>
        </div>
        <div class="col-3">
          <button type="button" id="submit-btn" class="btn btn-primary">Submit</button>
        </div>
      </div>


      <div class="row mt-3" id="results">
      </div>

    </div>
  </body>
</html>